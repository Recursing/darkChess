var app=function(){"use strict";function e(){}function n(e){return e()}function t(){return Object.create(null)}function o(e){e.forEach(n)}function r(e){return"function"==typeof e}function c(e,n){return e!=e?n==n:e!==n||e&&"object"==typeof e||"function"==typeof e}function s(e,n){e.appendChild(n)}function a(e,n,t){e.insertBefore(n,t||null)}function l(e){e.parentNode.removeChild(e)}function i(e){return document.createElement(e)}function u(e){return document.createTextNode(e)}function f(){return u(" ")}function d(){return u("")}function W(e,n,t,o){return e.addEventListener(n,t,o),()=>e.removeEventListener(n,t,o)}function p(e,n,t){null==t?e.removeAttribute(n):e.getAttribute(n)!==t&&e.setAttribute(n,t)}function h(e,n,t){e.classList[t?"add":"remove"](n)}let g;function m(e){g=e}function b(){if(!g)throw new Error("Function called outside component initialization");return g}function $(){const e=b();return(n,t)=>{const o=e.$$.callbacks[n];if(o){const r=function(e,n){const t=document.createEvent("CustomEvent");return t.initCustomEvent(e,!1,!1,n),t}(n,t);o.slice().forEach(n=>{n.call(e,r)})}}}const P=[],v=[],C=[],k=[],y=Promise.resolve();let w=!1;function E(e){C.push(e)}let x=!1;const M=new Set;function N(){if(!x){x=!0;do{for(let e=0;e<P.length;e+=1){const n=P[e];m(n),_(n.$$)}for(P.length=0;v.length;)v.pop()();for(let e=0;e<C.length;e+=1){const n=C[e];M.has(n)||(M.add(n),n())}C.length=0}while(P.length);for(;k.length;)k.pop()();w=!1,x=!1,M.clear()}}function _(e){if(null!==e.fragment){e.update(),o(e.before_update);const n=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,n),e.after_update.forEach(E)}}const O=new Set;function S(e,n){e&&e.i&&(O.delete(e),e.i(n))}function j(e,t,c){const{fragment:s,on_mount:a,on_destroy:l,after_update:i}=e.$$;s&&s.m(t,c),E(()=>{const t=a.map(n).filter(r);l?l.push(...t):o(t),e.$$.on_mount=[]}),i.forEach(E)}function T(e,n){const t=e.$$;null!==t.fragment&&(o(t.on_destroy),t.fragment&&t.fragment.d(n),t.on_destroy=t.fragment=null,t.ctx=[])}function q(e,n){-1===e.$$.dirty[0]&&(P.push(e),w||(w=!0,y.then(N)),e.$$.dirty.fill(0)),e.$$.dirty[n/31|0]|=1<<n%31}function D(n,r,c,s,a,i,u=[-1]){const f=g;m(n);const d=r.props||{},W=n.$$={fragment:null,ctx:null,props:i,update:e,not_equal:a,bound:t(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(f?f.$$.context:[]),callbacks:t(),dirty:u};let p=!1;if(W.ctx=c?c(n,d,(e,t,...o)=>{const r=o.length?o[0]:t;return W.ctx&&a(W.ctx[e],W.ctx[e]=r)&&(W.bound[e]&&W.bound[e](r),p&&q(n,e)),t}):[],W.update(),p=!0,o(W.before_update),W.fragment=!!s&&s(W.ctx),r.target){if(r.hydrate){const e=function(e){return Array.from(e.childNodes)}(r.target);W.fragment&&W.fragment.l(e),e.forEach(l)}else W.fragment&&W.fragment.c();r.intro&&S(n.$$.fragment),j(n,r.target,r.anchor),N()}m(f)}class I{$destroy(){T(this,1),this.$destroy=e}$on(e,n){const t=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return t.push(n),()=>{const e=t.indexOf(n);-1!==e&&t.splice(e,1)}}$set(){}}function L(e){return 12*(Math.floor(e/8)+2)+(e%8+2)}function R(e){return 8*(Math.floor(e/12)-2)+(e%12-2)}function A(e){switch(e){case 0:return"pawn";case 1:return"knight";case 2:return"bishop";case 3:return"rook";case 5:return"king";case 4:return"queen";case 6:return null}}var B="WWWWWWWWWWWWWWWWWWWWWWWWWWPPPPPPPPWWWWPPPPPPPPWWWW        WWWW        WWWW        WWWW        WWWWppppppppWWWWppppppppWWWWWWWWWWWWWWWWWWWWWWWWWW".split("").map((function(e){switch(e){case"W":return 3;case"P":return 1;case"p":return 0;case" ":return 2;default:throw Error("Invalid InitialColorsStr")}})),J="WWWWWWWWWWWWWWWWWWWWWWWWWWRNBQKBNRWWWWPPPPPPPPWWWW        WWWW        WWWW        WWWW        WWWWppppppppWWWWrnbqkbnrWWWWWWWWWWWWWWWWWWWWWWWWWW".split("").map((function(e){switch(e.toUpperCase()){case"W":case" ":return 6;case"P":return 0;case"R":return 3;case"N":return 1;case"B":return 2;case"Q":return 4;case"K":return 5;default:throw Error("Invalid InitialPiecesStr")}})),K=function(e){this.boardColors=B,this.myCastling=[!0,!0],this.opponentCastling=[!0,!0],this.enPassant=null,this.kingPassant=null,this.boardPieces=J,console.log("CONSTRUCTOR",e),"black"===e&&(this.boardPieces[L(3)]=5,this.boardPieces[L(4)]=4,this.boardPieces[L(60)]=4,this.boardPieces[L(59)]=5)};function Q(e,n,t){var o=L(n),r=L(t);if(console.log(n,t),e.boardPieces[r]=e.boardPieces[o],e.boardColors[r]=e.boardColors[o],e.boardPieces[o]=6,e.boardColors[o]=2,t<8&&0==e.boardPieces[r]&&(console.log("here"),e.boardPieces[r]=4),0==n?e.opponentCastling[0]=!1:7==n?e.opponentCastling[1]=!1:63==n?e.myCastling[1]=!1:56==n&&(e.myCastling[0]=!1),5==e.boardPieces[r]&&(0==e.boardColors[r]?e.myCastling=[!1,!1]:e.opponentCastling=[!1,!1]),5==e.boardPieces[r]&&2==Math.abs(t-n)){var c=Math.floor((t-n)/2);e.boardPieces[o+c]=3,e.boardColors[o+c]=e.boardColors[r],3===e.boardPieces[r+c]?(e.boardPieces[r+c]=6,e.boardColors[r+c]=2):3===e.boardPieces[r+c+c]?(e.boardPieces[r+c+c]=6,e.boardColors[r+c+c]=2):console.error("Messed up castling, sorry")}return e}function U(e,n){return function(e,n){if(0!=e.boardColors[n])return[];for(var t=e.boardPieces[n],o=[],r=0,c=function(e){switch(e){case 0:return[-12,-24,-13,-11];case 1:return[-23,-25,-14,10,23,25,14,-10];case 2:return[-11,-13,11,13];case 3:return[-12,-1,12,1];case 4:case 5:return[-12,-1,12,1,-11,-13,11,13];case 6:return console.error("Error getting moves from empty piec"),[]}}(t);r<c.length;r++)for(var s=c[r],a=1;a<=9;a++){var l=n+s*a,i=e.boardColors[l];if(3===i||0===i)break;if(0==t){if((-12==s||-24==s)&&2!=i)break;if((-13===s||-11===s)&&2===i&&e.enPassant!==l&&e.kingPassant!==l)break;if(-24==s&&(n<98||2!=e.boardColors[n+-12]))break}if(o.push(l),5==t&&(1==s||-1==s)){if(1==s&&!e.myCastling[0]||-1==s&&!e.myCastling[1])break;if(l+=s,2!==e.boardColors[l])break;if(2!==e.boardColors[l+s]&&3!==e.boardPieces[l+s])break;o.push(l)}if(2!==(u=t)&&3!==u&&4!==u)break;if(2!==i)break}var u;return o}(e,L(n)).map(R)}function z(e){let n,t,o,r=e[1]&&F(e);return{c(){n=i("p"),n.textContent="Establishing connection...",t=f(),r&&r.c(),o=d(),p(n,"class","svelte-q6c3dw")},m(e,c){a(e,n,c),a(e,t,c),r&&r.m(e,c),a(e,o,c)},p(e,n){e[1]?r?r.p(e,n):(r=F(e),r.c(),r.m(o.parentNode,o)):r&&(r.d(1),r=null)},d(e){e&&l(n),e&&l(t),r&&r.d(e),e&&l(o)}}}function F(e){let n,t,o;return{c(){n=i("a"),t=u(e[1]),p(n,"href",e[1]),p(n,"class","svelte-q6c3dw")},m(r,c,l){var i;a(r,n,c),s(n,t),l&&o(),o=W(n,"click",(i=e[6],function(e){return e.preventDefault(),i.call(this,e)}))},p(e,o){2&o&&function(e,n){n=""+n,e.data!==n&&(e.data=n)}(t,e[1]),2&o&&p(n,"href",e[1])},d(e){e&&l(n),o()}}}function G(n){let t,o=!n[0]&&z(n);return{c(){o&&o.c(),t=d()},m(e,n){o&&o.m(e,n),a(e,t,n)},p(e,[n]){e[0]?o&&(o.d(1),o=null):o?o.p(e,n):(o=z(e),o.c(),o.m(t.parentNode,t))},i:e,o:e,d(e){o&&o.d(e),e&&l(t)}}}function H(e,n,t){const o=$();let r=null,c=null;function s(e){const n=new Peer;n.on("open",()=>{console.log("Peer opened, connecting to:",e),t(0,r=n.connect(e)),r.on("open",()=>{r.on("data",e=>{console.log("got data:",e),o("onMessage",JSON.parse(e))})})}),n.on("error",e=>{console.error(e),alert(e)}),n.on("connection",e=>{console.log("CONNECTED!"),console.log(e)})}function a(){const e=new Peer;e.on("open",(function(n){console.log("My peer ID is: "+n),t(1,c=location.href+"#"+e.id)})),e.on("error",e=>{console.error(e),alert(e)}),e.on("connection",e=>{t(0,r=e),console.log("CONNECTED! with connection:"),console.log(e),e.on("data",e=>{console.log("got data:",e),o("onMessage",JSON.parse(e))}),e.on("close",()=>{console.error("connection closed"),alert("Connection closed!")})})}var l;l=async()=>{const e=location.hash.slice(1);e?(console.log("connecting to "+e),s(e)):(console.log("creating initiator peer"),a())},b().$$.on_mount.push(l);return[r,c,function(e){r.send(JSON.stringify(e))},o,s,a,()=>navigator.clipboard.writeText(c).then(()=>alert("Link copied! Send it to opponent"))]}class V extends I{constructor(e){super(),D(this,e,H,G,c,{sendObject:2})}get sendObject(){return this.$$.ctx[2]}}function X(e,n,t){const o=e.slice();return o[14]=n[t],o[16]=t,o}function Y(e){let n;return{c(){n=u("Waiting for other player...")},m(e,t){a(e,n,t)},d(e){e&&l(n)}}}function Z(e){let n;return{c(){n=u("Click a piece to play!")},m(e,t){a(e,n,t)},d(e){e&&l(n)}}}function ee(e){let n,t,o;return{c(){n=i("img"),n.src!==(t=e[7](e[14]))&&p(n,"src",t),p(n,"alt",o=e[14].name),p(n,"draggable","false"),p(n,"ondragstart","return false;"),p(n,"class","svelte-1fkacau")},m(e,t){a(e,n,t)},p(e,r){16&r&&n.src!==(t=e[7](e[14]))&&p(n,"src",t),16&r&&o!==(o=e[14].name)&&p(n,"alt",o)},d(e){e&&l(n)}}}function ne(n){let t;return{c(){t=i("div"),p(t,"class","unreachable svelte-1fkacau")},m(e,n){a(e,t,n)},p:e,d(e){e&&l(t)}}}function te(e){let n,t;function o(e,n){return e[5][e[16]]?ne:e[14].color?ee:void 0}let r=o(e),c=r&&r(e);function s(...n){return e[13](e[16],...n)}return{c(){n=i("div"),c&&c.c(),p(n,"class","square svelte-1fkacau"),h(n,"dark",Math.floor(9*e[16]/8)%2),h(n,"light",1-Math.floor(9*e[16]/8)%2),h(n,"selected",e[2]===e[16]),h(n,"move-dest",e[3].includes(e[16]))},m(e,o,r){a(e,n,o),c&&c.m(n,null),r&&t(),t=W(n,"click",s)},p(t,s){r===(r=o(e=t))&&c?c.p(e,s):(c&&c.d(1),c=r&&r(e),c&&(c.c(),c.m(n,null))),0&s&&h(n,"dark",Math.floor(9*e[16]/8)%2),0&s&&h(n,"light",1-Math.floor(9*e[16]/8)%2),4&s&&h(n,"selected",e[2]===e[16]),8&s&&h(n,"move-dest",e[3].includes(e[16]))},d(e){e&&l(n),c&&c.d(),t()}}}function oe(e){let n,t,o,r,c,u,d,W;function h(n){e[12].call(null,n)}let g={};void 0!==e[1]&&(g.sendObject=e[1]);const m=new V({props:g});function b(e,n){return e[0]?Z:Y}v.push(()=>function(e,n,t){const o=e.$$.props[n];void 0!==o&&(e.$$.bound[o]=t,t(e.$$.ctx[o]))}(m,"sendObject",h)),m.$on("onMessage",e[6]);let $=b(e),P=$(e),C=e[4],y=[];for(let n=0;n<C.length;n+=1)y[n]=te(X(e,C,n));return{c(){var e;(e=m.$$.fragment)&&e.c(),t=f(),o=i("h1"),P.c(),r=f(),c=i("div");for(let e=0;e<y.length;e+=1)y[e].c();u=f(),d=i("p"),d.innerHTML='\n    See rules on\n    <a href="https://en.wikipedia.org/wiki/Dark_chess">wikipedia!</a>',p(o,"class","svelte-1fkacau"),p(d,"class","svelte-1fkacau"),p(c,"id","board"),p(c,"class","svelte-1fkacau")},m(e,n){j(m,e,n),a(e,t,n),a(e,o,n),P.m(o,null),a(e,r,n),a(e,c,n);for(let e=0;e<y.length;e+=1)y[e].m(c,null);s(c,u),s(c,d),W=!0},p(e,[t]){const r={};var s;if(!n&&2&t&&(n=!0,r.sendObject=e[1],s=()=>n=!1,k.push(s)),m.$set(r),$!==($=b(e))&&(P.d(1),P=$(e),P&&(P.c(),P.m(o,null))),444&t){let n;for(C=e[4],n=0;n<C.length;n+=1){const o=X(e,C,n);y[n]?y[n].p(o,t):(y[n]=te(o),y[n].c(),y[n].m(c,u))}for(;n<y.length;n+=1)y[n].d(1);y.length=C.length}},i(e){W||(S(m.$$.fragment,e),W=!0)},o(e){!function(e,n,t,o){if(e&&e.o){if(O.has(e))return;O.add(e),(void 0).c.push(()=>{O.delete(e),o&&(t&&e.d(1),o())}),e.o(n)}}(m.$$.fragment,e),W=!1},d(e){T(m,e),e&&l(t),e&&l(o),P.d(),e&&l(r),e&&l(c),function(e,n){for(let t=0;t<e.length;t+=1)e[t]&&e[t].d(n)}(y,e)}}}function re(e,n,t){let o,{myColor:r}=n,c=new K(r),s="white"===r;function a(e){if(s){if(null!=l&&i.includes(e))return t(3,i=[]),console.log("making move!"),t(10,c=Q(c,l,e)),o([l,e]),t(0,s=!1),void t(2,l=null);if("mine"!==u[e].color)return t(2,l=null),void t(3,i=[]);t(2,l=e),t(3,i=U(c,e))}}console.log(c);let l=null,i=[];let u,f,d;return e.$set=e=>{"myColor"in e&&t(9,r=e.myColor)},e.$$.update=()=>{1024&e.$$.dirty&&t(4,u=function(e){for(var n=[],t=0;t<64;t++){var o=L(t),r=e.boardColors[o],c=null;0===r?c="mine":1===r&&(c="opponent"),n.push({color:c,name:A(e.boardPieces[o])})}return n}(c)),1040&e.$$.dirty&&t(11,f=u.flatMap((e,n)=>U(c,n))),2064&e.$$.dirty&&t(5,d=u.map((e,n)=>"mine"!==e.color&&!f.includes(n)))},[s,o,l,i,u,d,function(e){console.log("Got message"),console.log(e);let[n,o]=e.detail,r=function(e){return 63-e};t(10,c=Q(c,r(n),r(o))),t(2,l=null),t(3,i=[]),t(0,s=!0)},function(e){let n=r;return"opponent"===e.color&&(n="white"===r?"black":"white"),`./images/${n}/${e.name}.svg`},a,r,c,f,function(e){o=e,t(1,o)},e=>a(e)]}return new class extends I{constructor(e){super(),D(this,e,re,oe,c,{myColor:9})}}({target:document.body,props:{myColor:location.hash?"black":"white"}})}();
//# sourceMappingURL=bundle.js.map
